@startuml SequenceDiagram
title Join Private Class

actor User

participant ": Frontend" as Frontend
participant ": Router" as Router
participant ": Middleware" as Middleware
participant ": EnrollmentController" as EnrollmentController
participant ": EnrollmentService" as EnrollmentService
participant ": ClassService" as ClassService
participant ": EnrollmentRepository" as EnrollmentRepository
database Database

' 1. ผู้ใช้กดปุ่ม join class และแสดงฟอร์ม
User -> Frontend: Click "Join Class" button
Frontend -> User: Display join class form

' 2. ผู้ใช้กรอก invite code แล้วส่งข้อมูล
User -> Frontend: Submit invite code
Frontend -> Router: POST /api/enrollments/{inviteCode}
activate Router

' ตรวจสอบสิทธิ์ผู้ใช้ผ่าน Middleware
Router -> Middleware: Use Authentication Middleware
activate Middleware
Middleware -> Middleware: Verify User
alt Unauthorized
  Middleware -->> Router: 401 Unauthorized
  Router -->> Frontend: 401 Unauthorized
  Frontend -->> User: Show error "Please log in"
else Authorized
  Middleware -->> Router: Continue routing
  deactivate Middleware

  ' เรียก EnrollmentController เพื่อ join class
  Router -> EnrollmentController: joinPrivateClass(inviteCode)
  activate EnrollmentController
  EnrollmentController -> EnrollmentService: joinPrivateClass(inviteCode)
  activate EnrollmentService

  ' ตรวจสอบ invite code (SQL Call 1)
  EnrollmentService -> ClassService: validateInviteCode(inviteCode)
  activate ClassService
  ClassService -> Database: SELECT (class_Id) FROM Classes WHERE invite_code = <invite_code>;
  activate Database
  Database -->> ClassService: Class record or not found
  deactivate Database
  ClassService -->> EnrollmentService: Class record or null
  deactivate ClassService

  alt Class Not Found
    EnrollmentService -->> EnrollmentController: null
  else Class Found
    ' บันทึกข้อมูลการเข้าร่วม class (SQL Call 2: บันทึก user_classes)
    EnrollmentService -> EnrollmentRepository: insertUserClass(user_id, class_id)
    activate EnrollmentRepository
    EnrollmentRepository -> Database: INSERT INTO User_Class (user_id, class_id) VALUES (<user_id>, <class_id>);
    activate Database
    Database -->> EnrollmentRepository: Success or error
    deactivate Database

    ' บันทึกข้อมูลการเข้าร่วม class (SQL Call 3: บันทึก user_courses)
    EnrollmentRepository -> Database: INSERT INTO user_courses (user_id, class_id) VALUES (@user_id, @class_id)
    activate Database
    Database -->> EnrollmentRepository: Success or error
    deactivate Database
    EnrollmentRepository -->> EnrollmentService: Enrollment record or error
    deactivate EnrollmentRepository
    EnrollmentService -->> EnrollmentController: Enrollment record or error
  end

  ' ตรวจสอบผลการดำเนินการใน EnrollmentController
  alt Error during enrollment
    EnrollmentController -->> Router: 500 Internal Server Error
    Router -->> Frontend: 500 Internal Server Error
    Frontend -->> User: Show error "Failed to join class"
  else Enrollment == null
    EnrollmentController -->> Router: 404 Not Found
    Router -->> Frontend: 404 Not Found
    Frontend -->> User: Show message "Class not found"
  else Enrollment record returned (Success)
    EnrollmentController -->> Router: 200 OK
    Router -->> Frontend: 200 OK
    Frontend -->> User: Show success "Joined class"
  end

  deactivate EnrollmentController
  deactivate Router
end

@enduml
