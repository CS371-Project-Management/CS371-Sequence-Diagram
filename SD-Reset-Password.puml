@startuml
title Reset Password Flow

actor User
participant "Frontend" as FE
participant Router
participant "Middleware" as MW
participant "User Controller" as UC
participant "User Service" as US
participant "User Repository" as UR
participant "Database" as DB
participant "Email Service" as ES

'Phase 1: Request Reset Password'
activate FE
User -> FE: handleForgotPasswordClick()
FE -> User: displayForgotPasswordForm()
User -> FE: handleForgotPasswordSubmit(username, email)
FE -> Router: POST /api/users/reset-password-request {username, email}
activate Router
Router -> MW: validateRequest()
activate MW
MW -> UC: ResetPasswordRequest(username, email)
deactivate MW
activate UC
UC -> UC: validatePayload()
alt Invalid Payload (4.1a)
    UC -> Router: returnErrorResponse(400,"ข้อมูลไม่ครบถ้วนหรือข้อมูลไม่ถูกต้อง")
    Router -> FE: errorResponse(400)
    deactivate UC
    deactivate Router
else Valid Payload
    UC -> US: ResetPasswordRequest(username, email)
    activate US
    US -> UR: findUserByUsernameAndEmail(username, email)
    activate UR
    UR -> DB: SELECT id, username, email FROM users WHERE username=? AND email=?
    activate DB
    DB -->> UR: userRecord
    deactivate DB
    alt User Not Found (5.1a)
        UR -->> US: nil
        deactivate UR
        US -> UC: returnError("ไม่พบชื่อบัญชีที่ลงทะเบียนกับอีเมลนี้")
        deactivate US
        UC -> Router: returnErrorResponse(404,"ไม่พบชื่อบัญชีที่ลงทะเบียนกับอีเมลนี้")
        Router -> FE: errorResponse(404)
        deactivate UC
        deactivate MW
        deactivate Router
    else User Found
        UR -->> US: userRecord
        deactivate UR
        US -> UC: userRecord
        deactivate US
        UC -> ES: sendResetPasswordEmail(userRecord)
        activate ES
        ES -->> User: sendEmail(resetTokenLink)
        deactivate ES
        UC -> Router: returnSuccessResponse(200,"กรุณาตรวจสอบอีเมล")
        Router -> FE: successResponse(200)
        deactivate UC
        deactivate MW
        deactivate Router
    end
end
FE -> User: displayMessage("Reset email sent")
deactivate FE

'Phase 2: Execute Reset Password'
User -> FE: handleResetPasswordLinkClick(token)
activate FE
FE -> User: displayResetPasswordForm()
User -> FE: handleResetPasswordSubmit(token, newPassword)
FE -> Router: POST /api/users/reset-password {token, newPassword}
activate Router
Router -> MW: validateRequest()
activate MW
MW -> UC: ResetPassword(token, newPassword)
deactivate MW
activate UC
UC -> UC: validateToken(token)
UC -> UC: validateNewPassword(newPassword)
alt Invalid New Password (9.1a)
    UC -> Router: returnErrorResponse(400,"รหัสผ่านไม่ผ่านเงื่อนไขขั้นต่ำที่กำหนด")
    Router -> FE: returnErrorResponse(400,"รหัสผ่านไม่ผ่านเงื่อนไขขั้นต่ำที่กำหนด")
    deactivate Router
else Valid New Password
    UC -> US: ResetPassword(token, newPassword)
    activate US
    US -> UR: updateUserPasswordByToken(token, hash(newPassword))
    activate UR
    UR -> DB: UPDATE users SET password=? WHERE reset_token=?
    activate DB
    DB -->> UR: affectedRows
    deactivate DB
    UR -->> US: success
    deactivate UR
    US -> UC: success
    deactivate US
    UC -> Router: returnSuccessResponse(200,"แก้ไขรหัสผ่านสำเร็จ")
    deactivate UC
    Router -> FE: successResponse(200,"แก้ไขรหัสผ่านสำเร็จ")
    deactivate UC
    deactivate MW
    deactivate Router
    FE -> User: showResetSuccessMessage()

end
deactivate FE

@enduml
