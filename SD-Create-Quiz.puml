@startuml SequenceDiagram
title Create Quiz

actor User
participant ": Frontend" as Frontend
participant ": Router" as Router
participant ": Middleware" as Middleware

participant ": ClassController" as ClassController
participant ": ClassService" as ClassService
participant ": ClassRepository" as ClassRepository

participant ": CourseController" as CourseController
participant ": CourseService" as CourseService
participant ": CourseRepository" as CourseRepository

participant ": QuizController" as QuizController
participant ": QuizService" as QuizService
participant ": QuizRepository" as QuizRepository

database Database

activate Frontend


Frontend -> Router: GET /api/classes
activate Router

Router -> Middleware: .Use(Middleware)
activate Middleware
Middleware -> Middleware : .Verify()

alt Unauthorized (401 Unauthorized)
  Middleware -->> Router: 401 Unauthorized
  Router -->> Frontend: 401 Unauthorized
  Frontend -->> User: Show error "Please log in"
else Authorized
  Middleware -->> Router: Route to Router
  deactivate Middleware
  Router -> ClassController: .GetAllClasses()
  activate ClassController
  ClassController -> ClassService: .GetAllClasses()
  activate ClassService
  ClassService -> ClassRepository: .GetAllClasses()
  activate ClassRepository
  ClassRepository -> Database: SELECT * FROM classes WHERE owner_id = @user_id
  activate Database
  Database -->> ClassRepository : Classes, Error
  deactivate Database
  ClassRepository -->> ClassService : Classes, Error
  deactivate ClassRepository
  ClassService -->> ClassController : Classes, Error
  deactivate ClassService
  alt Error != Null
    ClassController -->> Router : 500 Internal Server Error
    Router -->> Frontend : 500 Internal Server Error
    Frontend -->> User : Show error "Failed to fetch classes"
  else Classes == Null
    ClassController -->> Router : 404 Not Found
    Router -->> Frontend : 404 Not Found
    Frontend -->> User : Show message "Class not found"
  else
    ClassController -->> Router : 200 OK
    Router -->> Frontend : 200 OK
    Frontend -->> User : Show classes list
  end
  deactivate ClassController
  deactivate Router

  opt User selects a class
    User -> Frontend: .handleClassClick(classId)
    Frontend -> Router: GET /api/courses/{classId}
    activate Router

    Router -> Middleware: .Use(Middleware)
    activate Middleware
    Middleware -> Middleware : .Verify()
    alt Unauthorized (401 Unauthorized)
      Middleware -->> Router: 401 Unauthorized
      Router -->> Frontend: 401 Unauthorized
      Frontend -->> User: Show error "Please log idn"
    else Authorized
      Middleware -->> Router: Route to Router
      deactivate Middleware
      Router -> CourseController: .GetAllCourses(classId)
      activate CourseController
      CourseController -> CourseService: .GetAllCourses(classId)
      activate CourseService
      CourseService -> CourseRepository: .GetAllCourses(classId)
      activate CourseRepository
      CourseRepository -> Database: SELECT * FROM courses WHERE class_id = @class_id
      activate Database
      Database -->> CourseRepository : Courses, Error
      deactivate Database
      CourseRepository -->> CourseService : Courses, Error
      deactivate CourseRepository
      CourseService -->> CourseController : Courses, Error
      deactivate CourseService
      alt Error != Null
        CourseController -->> Router : 500 Internal Server Error
        Router -->> Frontend : 500 Internal Server Error
        Frontend -->> User : Show error "Failed to fetch courses"
      else Courses == Null
        CourseController -->> Router : 404 Not Found
        Router -->> Frontend : 404 Not Found
        Frontend -> User: Show message "Course not found"
      else
        CourseController -->> Router : 200 OK
        Router -->> Frontend : 200 OK
        Frontend -->> User : Show courses list
      end
      deactivate CourseController
      deactivate Router
      
      opt User selects a course
        User -> Frontend: .handleCourseClick(courseId)
        Frontend -> Router: GET /api/courses/{courseId}
        activate Router
        Router -> Middleware: .Use(Middleware)
        activate Middleware
        Middleware -> Middleware : .Verify()
        alt Unauthorized (401 Unauthorized)
          Middleware -->> Router: 401 Unauthorized
          Router -->> Frontend: 401 Unauthorized
          Frontend -->> User: Show error "Please log in"
        else Authorized
          Middleware -->> Router: Route to Router
          deactivate Middleware
          Router -> CourseController: .GetCourse(courseId)
          activate CourseController
          CourseController -> CourseService: .GetCourse(courseId)
          activate CourseService
          CourseService -> CourseRepository: .GetCourse(courseId)
          activate CourseRepository
          CourseRepository -> Database: SELECT * FROM courses WHERE id = @course_id
          activate Database
          Database -->> CourseRepository : Course, Error
          deactivate Database
          CourseRepository -->> CourseService : Course, Error
          deactivate CourseRepository
          CourseService -->> CourseController : Course, Error
          deactivate CourseService
          alt Error != Null
            CourseController -->> Router : 500 Internal Server Error
            Router -->> Frontend : 500 Internal Server Error
            Frontend -->> User : Show error "Failed to fetch course"
          else
            CourseController -->> Router : 200 OK
            Router -->> Frontend : 200 OK
            Frontend -->> User : Show course details
          end
          deactivate CourseController
          deactivate Router
          User -> Frontend : handleCreateQuizClick(courseId)
          Frontend -->> User : Show quiz creation form
          User -> Frontend : handleSelectQuizType()
          Frontend -->> User : Show quiz type options
          User -> Frontend : handleSubmitQuizClick(courseId, content, quiz_type, requirements)
          Frontend -> Frontend : Validate quiz data
          alt Invalid Data
            Frontend -->> User : Show error "Invalid input"
          else Valid Data
            Frontend -> Router: POST /api/quizzes
            activate Router
            Router -> Middleware: .Use(Middleware)
            activate Middleware
            Middleware -> Middleware : .Verify()
            alt Unauthorized (401 Unauthorized)
              Middleware -->> Router: 401 Unauthorized
              Router -->> Frontend: 401 Unauthorized
              Frontend -->> User: Show error "Please log in"
            else Authorized
              Middleware -->> Router: Route to Router
              deactivate Middleware
              Router -> QuizController: .CreateQuiz(courseId, content, quiz_type, requirements)
              activate QuizController
              QuizController -> QuizService: .CreateQuiz(courseId, content, quiz_type, requirements)
              activate QuizService
              QuizService -> QuizRepository: .CreateQuiz(courseId, content, quiz_type, requirements)
              activate QuizRepository
              QuizRepository -> Database: INSERT INTO quizzes (course_id, content, quiz_type, requirements) VALUES (@course_id, @content, @quiz_type, @requirements)
              activate Database
              Database -->> QuizRepository : Quiz, Error
              deactivate Database
              QuizRepository -->> QuizService : Quiz, Error
              deactivate QuizRepository
              QuizService -->> QuizController : Quiz, Error
              deactivate QuizService
              alt Error != Null
                QuizController -->> Router : 500 Internal Server Error
                Router -->> Frontend : 500 Internal Server Error
                Frontend -->> User : Show error "Quiz creation failed"
              else
                QuizController -->> Router : 201 Created
                Router -->> Frontend : 201 Created
                Frontend -->> User : Show success "Quiz created"
              end
              deactivate QuizController
              deactivate Router
            end
          end
        end
      end
    end
  end
end
@enduml
